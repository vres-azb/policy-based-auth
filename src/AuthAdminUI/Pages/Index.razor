@page "/"
@using PolicyBased.Infra.Models
@using PolicyBased.Infra.Persistence.Repositories
@using PolicyDtos = PolicyBased.Infra.Dtos;

@inject IUserRepo UserRepo;
<PageTitle>Policies</PageTitle>

<FluentBreadcrumb>
    <FluentBreadcrumbItem Href="#">
        <h5>
            Policies
        </h5>
    </FluentBreadcrumbItem>
</FluentBreadcrumb>

<FluentDataGrid Items="@policyList" ItemKey="(a=>a.Id)" Style="width:870px;" ResizableColumns="false">
    <EmptyContent>No policies</EmptyContent>
    <ChildContent>
        <TemplateColumn Title="Actions">
            <FluentAnchor Href="/Policies/Edit" IconStart="@(new Icons.Regular.Size24.Edit())">
            </FluentAnchor>
        </TemplateColumn>
        <PropertyColumn Align="Align.Start" Property="@(a => a.Name)" Style="width:80px;" Sortable="true" />
        <TemplateColumn Style="width:700px;" Title="Policy" Context="policyContext" Align="Align.Start">
            <FluentDataGrid Items="@policyContext.Policies.AsQueryable()" ResizableColumns="false" GenerateHeader="GenerateHeaderOption.None">
                <PropertyColumn Property="@(p => p.Name)" Sortable="true" Style="width:100px;" />
                <TemplateColumn Context="permContext">
                    @{
                        var perms = permContext.Permissions.AsQueryable();
                    }
                    <FluentDataGrid Items="@perms">
                        <PropertyColumn Property="@(p => p.Name)" Title="Permission" Sortable="true" Style="width:180px;" />
                        <TemplateColumn Title="Roles">
                            @{
                                string[] roles = permContext.Roles.Select(a => a.Name).ToArray();
                                string roleNames = string.Join(", ", roles);
                            }
                            <FluentLabel>@roleNames</FluentLabel>
                            </TemplateColumn>
                        </FluentDataGrid>
                    </TemplateColumn>
                </FluentDataGrid>
            </TemplateColumn>
        </ChildContent>
    </FluentDataGrid>

    @code {
    IQueryable<PolicyDtos.Application>? policyList = null;
    int currentAppId;
    protected override async Task OnInitializedAsync()
    {
        var allPolicies = await UserRepo.GetPolicies();
        policyList = allPolicies.AsQueryable();
    }
}